name: Deploy Lab API to Dreamhost

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-lab-api
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build API
        run: npm run build

      - name: Verify build output exists
        run: |
          test -d dist
          ls -la dist

      - name: Check OpenAPI spec (optional)
        run: |
          if [ -f openapi/openapi.json ]; then
            echo "✅ OpenAPI spec present"
          else
            echo "ℹ️ No OpenAPI spec found (optional)"
          fi

      # Stage a deploy bundle so we ship dist + package manifests
      - name: Create deploy bundle
        run: |
          rm -rf deploy_bundle
          mkdir -p deploy_bundle
          cp -R dist deploy_bundle/dist
          cp package.json package-lock.json deploy_bundle/
          # If you use a PM2 ecosystem file, include it:
          cp ecosystem.config.js deploy_bundle/

      - name: Ensure remote deploy dir exists
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "SSH user: $(whoami)"
            echo "Target: ${{ secrets.SFTP_PATH }}"
            mkdir -p "${{ secrets.SFTP_PATH }}"
            ls -ld "${{ secrets.SFTP_PATH }}"

      - name: Inspect deploy bundle contents
        run: |
          echo "PWD=$(pwd)"
          ls -la
          ls -la deploy_bundle
          find deploy_bundle -maxdepth 3 -type f | head -n 50

      - name: Deploy via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          local_path: "./deploy_bundle/"
          remote_path: "${{ secrets.SFTP_PATH }}"
          sftp_only: true
          delete_remote_files: false

      - name: Restart API with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            whoami
            cd "${{ secrets.SFTP_PATH }}"
            npm ci --omit=dev
            pm2 restart lab-api
            pm2 save
