name: Deploy Lab API to Dreamhost

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-lab-api
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build API
        run: npm run build

      - name: Verify build output exists
        run: |
          set -e
          test -d dist
          ls -la dist

      - name: Check OpenAPI spec (optional)
        run: |
          if [ -f openapi/openapi.json ]; then
            echo "✅ OpenAPI spec present"
          else
            echo "ℹ️ No OpenAPI spec found (optional)"
          fi

      - name: Create deploy bundle
        run: |
          set -e
          rm -rf deploy_bundle
          mkdir -p deploy_bundle

          cp -R dist deploy_bundle/dist
          cp package.json package-lock.json deploy_bundle/

          # Include PM2 ecosystem file if present
          if [ -f ecosystem.config.js ]; then
            cp ecosystem.config.js deploy_bundle/
            echo "✅ Included ecosystem.config.js"
          else
            echo "ℹ️ No ecosystem.config.js found (optional)"
          fi

      - name: Validate deploy secrets (fail fast)
        run: |
          test -n "${{ secrets.SFTP_HOST }}" || (echo "Missing SFTP_HOST" && exit 1)
          test -n "${{ secrets.SFTP_USER }}" || (echo "Missing SFTP_USER" && exit 1)
          test -n "${{ secrets.SFTP_PATH }}" || (echo "Missing SFTP_PATH" && exit 1)
          test -n "${{ secrets.SSH_PRIVATE_KEY }}" || (echo "Missing SSH_PRIVATE_KEY" && exit 1)
          test -n "${{ secrets.SSH_PORT }}" || (echo "Missing SSH_PORT" && exit 1)

      - name: Ensure remote deploy dir exists
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -e
            echo "SSH user: $(whoami)"
            echo "Target: ${{ secrets.SFTP_PATH }}"
            mkdir -p "${{ secrets.SFTP_PATH }}"
            ls -ld "${{ secrets.SFTP_PATH }}"

      - name: Inspect deploy bundle contents
        run: |
          set -e
          echo "PWD=$(pwd)"
          ls -la
          ls -la deploy_bundle
          find deploy_bundle -maxdepth 3 -type f | head -n 50

      - name: Upload deploy bundle via scp (key auth)
        shell: bash
        run: |
          set -euo pipefail
      
          PORT="${{ secrets.SSH_PORT }}"
          PORT="${PORT:-22}"
      
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
      
          ssh-keyscan -p "$PORT" -H "${{ secrets.SFTP_HOST }}" >> ~/.ssh/known_hosts
      
          # Upload contents of deploy_bundle into the remote deploy dir
          scp -P "$PORT" -r deploy_bundle/* \
            "${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_PATH }}/"

      - name: Restart API with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -u
            set -o pipefail
            set -x
          
            # Safe sourcing: never returns non-zero if file is missing/empty
            if [ -r "$HOME/.profile" ] && [ -s "$HOME/.profile" ]; then . "$HOME/.profile"; fi
            if [ -r "$HOME/.bash_profile" ] && [ -s "$HOME/.bash_profile" ]; then . "$HOME/.bash_profile"; fi
            if [ -r "$HOME/.bashrc" ] && [ -s "$HOME/.bashrc" ]; then . "$HOME/.bashrc"; fi
            if [ -r "$HOME/.nvm/nvm.sh" ] && [ -s "$HOME/.nvm/nvm.sh" ]; then . "$HOME/.nvm/nvm.sh"; fi
          
            # nvm use: also must not return non-zero
            if command -v nvm >/dev/null 2>&1; then
              nvm use --lts >/dev/null 2>&1 || nvm use node >/dev/null 2>&1 || true
            fi
          
            echo "PATH=$PATH"
            which node || true
            which npm || true
            node -v || true
            npm -v || true
          
            cd "${{ secrets.SFTP_PATH }}"
            ls -la
          
            # hard fail if npm still missing
            command -v npm >/dev/null 2>&1 || { echo "FAIL: npm not on PATH in this shell"; exit 1; }
          
            npm ci --omit=dev
          
            if ! command -v pm2 >/dev/null 2>&1; then
              npm i -g pm2
            fi
          
            pm2 -v || true
            pm2 list || true
          
            if [ -f ecosystem.config.js ]; then
              pm2 start ecosystem.config.js --update-env
            else
              pm2 restart lab-api --update-env || pm2 start dist/index.js --name lab-api --update-env
            fi
          
            pm2 save
            pm2 list || true
