name: "Carmel Guard: Submodule Judgment"

on:
  pull_request:
  push:
    branches: [main]

jobs:
  carmel-guard:
    name: "CJO: Carmel Submodule Guard ðŸ¾"
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ¾ Carmel arrives (checkout)"
        uses: actions/checkout@v4

      - name: "ðŸ‘ï¸ Carmel squints at .gitmodules"
        run: |
          set -euo pipefail
          if [ ! -f .gitmodules ]; then
            echo "::error::Carmel Judgment: .gitmodules is missing. Submodule not configured."
            exit 1
          fi
          echo "âœ… .gitmodules found"

      - name: "ðŸ“¦ Carmel checks the content vault (content/)"
        run: |
          set -euo pipefail

          if [ ! -d content ]; then
            echo "::error::Carmel Judgment: content/ is missing. Submodule not checked out."
            echo "Fix: git submodule update --init --recursive"
            exit 1
          fi

          if [ -z "$(ls -A content 2>/dev/null)" ]; then
            echo "::error::Carmel Judgment: content/ exists but is empty. Submodule likely not initialized."
            echo "Fix: git submodule update --init --recursive"
            exit 1
          fi

          echo "âœ… content/ exists and is not empty"

      - name: "ðŸ§¾ Carmel reads the submodule status (no minus signs allowed)"
        run: |
          set -euo pipefail

          # A leading "-" in `git submodule status` indicates not initialized.
          if git submodule status --recursive 2>/dev/null | grep -qE '^\-'; then
            echo "::error::Carmel Judgment: submodule(s) not initialized."
            echo "Fix: git submodule update --init --recursive"
            echo ""
            echo "Current status:"
            git submodule status --recursive || true
            exit 1
          fi

          echo "âœ… submodules initialized (Carmel approves)"

      # OPTIONAL: enforce expected structure (uncomment if you want hard guarantees)
      # - name: "ðŸ“š Carmel verifies expected folders"
      #   run: |
      #     set -euo pipefail
      #     test -d content/labnotes/en || (echo "::error::Missing content/labnotes/en" && exit 1)
      #     test -d content/labnotes/ko || (echo "::error::Missing content/labnotes/ko" && exit 1)
      #     echo "âœ… expected content folders found"
